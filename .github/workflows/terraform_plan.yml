name: Terraform Plan
run-name: ${{ github.actor }} is testing out GitHub Actions ğŸš€

on: 
  workflow_dispatch:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, closed]
    paths:
      - 'src/terraform/platforms/*'
      - 'src/terraofrm/infrastructures/*'
      - 'src/terraform/services/*'
      - 'src/terraform/web-site/*'

permissions:
  pull-requests: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-20.04
    steps:
      - name: Test First
        run: echo "This is First job"

      - name: Verify Github Contexts
        run: |
          echo "github.action ${{github.action}}" # string  ç¾åœ¨å®Ÿè¡Œä¸­ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åå‰ã€‚ GitHubã¯ã€ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã™ã‚‹éš›ã«ã€ç‰¹æ®Šãªã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ã‹ã€runã¨ã„ã†åå‰ã‚’ä½¿ã„ã¾ã™ã€‚ åŒã˜ã‚¸ãƒ§ãƒ–ã®ä¸­ã§åŒã˜ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¤‡æ•°å›ä½¿ã†å ´åˆã€åå‰ã«ã¯é †ç•ªã«ç•ªå·ãŒåŠ ãˆã‚‰ã‚Œã¾ã™ã€‚ ãŸã¨ãˆã°ã€å®Ÿè¡Œã™ã‚‹æœ€åˆã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åå‰ã¯run1ã§ã€2ç•ªç›®ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åå‰ã¯run2ã¨ã„ã†ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ åŒæ§˜ã«ã€actions/checkoutã®2å›ç›®ã®å‘¼ã³å‡ºã—ã¯actionscheckout2ã¨ãªã‚Šã¾ã™ã€‚
          echo "github.action_path ${{github.action_path}}" # string    ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç½®ã‹ã‚Œã¦ã„ã‚‹ãƒ‘ã‚¹ã€‚ ã“ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã«ç°¡å˜ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ This attribute is only supported in composite actions.
          echo "github.actor ${{github.actor}}" # string    ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’é–‹å§‹ã—ãŸãƒ¦ãƒ¼ã‚¶ã®ãƒ­ã‚°ã‚¤ãƒ³ã€‚
          echo "github.base_ref ${{github.base_ref}}" # string  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«ãŠã‘ã‚‹ base_ref ã¾ãŸã¯Pull Requestã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ–ãƒ©ãƒ³ãƒã€‚ ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒ pull_request ã¾ãŸã¯ pull_request_target ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹å ´åˆã«ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚
          echo "github.event ${{github.event}}" # ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ    webhook ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã®å®Œå…¨ãªã‚¤ãƒ™ãƒ³ãƒˆã€‚ è©³ã—ã„æƒ…å ±ã«ã¤ã„ã¦ã¯ã€ã€Œãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚ ã“ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€ã‚¤ãƒ™ãƒ³ãƒˆã®å€‹ã€…ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚
          echo "github.event_name ${{github.event_name}}" # string  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã®åå‰ã€‚
          echo "github.event_path ${{github.event_path}}" # string  ãƒ©ãƒ³ãƒŠãƒ¼ä¸Šã®å®Œå…¨ãªã‚¤ãƒ™ãƒ³ãƒˆwebhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã¸ã®ãƒ‘ã‚¹ã€‚
          echo "github.head_ref ${{github.head_ref}}" # string  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«ãŠã‘ã‚‹ head_ref ã¾ãŸã¯Pull Requestã®ã‚½ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã€‚ ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒ pull_request ã¾ãŸã¯ pull_request_target ã®ã„ãšã‚Œã‹ã§ã‚ã‚‹å ´åˆã«ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚
          echo "github.job ${{github.job}}" # string    ç¾åœ¨ã®ã‚¸ãƒ§ãƒ–ã®job_idã€‚
          echo "github.ref ${{github.ref}}" # string    ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãŸãƒ–ãƒ©ãƒ³ãƒã¾ãŸã¯ã‚¿ã‚° refã€‚ For branches this is the format refs/heads/<branch_name>, and for tags it is refs/tags/<tag_name>.
          echo "github.repository ${{github.repository}}" # string  æ‰€æœ‰è€…ãŠã‚ˆã³ãƒªãƒã‚¸ãƒˆãƒªã®åå‰ã€‚ Codertocat/Hello-Worldãªã©ã§ã™ã€‚
          echo "github.repository_owner ${{github.repository_owner}}" # string  ãƒªãƒã‚¸ãƒˆãƒªã®ã‚ªãƒ¼ãƒŠãƒ¼ã®åå‰ã€‚ ãŸã¨ãˆã°Codertocatã€‚
          echo "github.run_id ${{github.run_id}}" # string  ãƒªãƒã‚¸ãƒˆãƒªå†…ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªå„å®Ÿè¡Œã«å¯¾ã™ã‚‹ç•ªå·ã€‚ ã“ã®ç•ªå·ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ã‚„ã‚Šç›´ã—ã¦ã‚‚å¤‰åŒ–ã—ã¾ã›ã‚“ã€
          echo "github.run_number ${{github.run_number}}" # string  ãƒªãƒã‚¸ãƒˆãƒªå†…ã®ç‰¹å®šã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å„å®Ÿè¡Œã«å¯¾ã™ã‚‹ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç•ªå·ã€‚ ã“ã®ç•ªå·ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æœ€åˆã®å®Ÿè¡Œæ™‚ã«1ã§å§‹ã¾ã‚Šã€æ–°ãŸãªå®Ÿè¡Œã”ã¨ã«ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆã•ã‚Œã¾ã™ã€‚ ã“ã®ç•ªå·ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ã‚„ã‚Šç›´ã—ã¦ã‚‚å¤‰åŒ–ã—ã¾ã›ã‚“ã€
          echo "github.sha ${{github.sha}}" # string    ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ãŸã‚³ãƒŸãƒƒãƒˆ SHAã€‚
          echo "github.token ${{github.token}}" # string    ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸGitHub Appã®ä»£ã‚ã‚Šã«èªè¨¼ã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ã€‚ ã“ã‚Œã¯æ©Ÿèƒ½çš„ã«GITHUB_TOKENã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã«ç­‰ä¾¡ã§ã™ã€‚ è©³ã—ã„æƒ…å ±ã«ã¤ã„ã¦ã¯ã€ŒGITHUB_TOKENã§ã®èªè¨¼ã€ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚
          echo "github.workflow ${{github.workflow}}" # string  ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®åå‰ã€‚ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã§ name ã‚’æŒ‡å®šã—ã¦ã„ãªã„å ´åˆã€ã“ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªå†…ã«ã‚ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã«ãªã‚Šã¾ã™ã€‚
          echo "github.workspace ${{github.workspace}}" # string    checkoutã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†éš›ã®ã€ã‚¹ãƒ†ãƒƒãƒ—ã«ã¨ã£ã¦ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã‚ã‚Šã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å ´æ‰€ã§ã™ã€‚


  changes:
    name: Changes
    runs-on: ubuntu-20.04
    needs: test
    outputs:
      platforms: ${{ steps.filter.outputs.platforms }}
      platforms_files: ${{ steps.filter.outputs.platforms_files }}
      infrastructures: ${{ steps.filter.outputs.infrastructures }}
      infrastructures_files: ${{ steps.filter.outputs.infrastructures_files }}
      services: ${{ steps.filter.outputs.services }}
      services_files: ${{ steps.filter.outputs.services_files }}
      web-sites: ${{ steps.filter.outputs.web-sites }}
      web-sites_files: ${{ steps.filter.outputs.web-sites_files }}
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: filter
        id: filter
        uses: dorny/paths-filter@v2
        with:
          list-files: json
          filters: |
            platforms:
              - 'src/terraform/platforms/**'
            infrastructures:
              - 'src/terraofrm/infrastructures/**'
            services:
              - 'src/terraform/services/**'
            web-sites:
              - 'src/terraform/web-site/**'

      - name: changed
        run: echo "aaa" ${{ steps.filter.outputs.platforms_files }}

  platforms:
    needs: changes
    if: ${{ needs.changes.outputs.platforms == 'true' }}
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: echo hi
        run: echo "do platforms job"

      - name: changeds files
        run: echo "this is changed files:" ${{ needs.changes.outputs.platforms_files }}

  infrastructures:
    needs: changes
    if: ${{ needs.changes.outputs.infrastructures == 'true' }}
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - run: echo "do infrastructures job"

      - name: changeds files
        run: echo "this is changed files:" ${{ needs.changes.outputs.infrastructures_files }}

  services:
    needs: changes
    if: ${{ needs.changes.outputs.services == 'true' }}
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - run: echo "do services job"

      - name: changeds files
        run: echo "this is changed files:" ${{ needs.changes.outputs.services_files }}

  web-sites:
    needs: changes
    if: ${{ needs.changes.outputs.web-sites == 'true' }}
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - run: echo "do web-sites job"

      - name: changeds files
        run: echo "this is changed files:" ${{ needs.changes.outputs.web-sites_filters }}
